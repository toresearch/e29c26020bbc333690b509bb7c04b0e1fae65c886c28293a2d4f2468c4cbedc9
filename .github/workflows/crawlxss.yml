name: Run CrawlXSS Scanner

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Make crawlxss executable
        run: chmod +x ./crawlxss

      - name: Create directories
        run: |
          mkdir -p results
          mkdir -p track

      - name: Get next target to scan
        id: get_target
        run: |
          if [ ! -f wildcards.txt ]; then
            echo "No wildcards.txt found"
            echo "target=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          while IFS= read -r line || [ -n "$line" ]; do
            if [ -z "$line" ]; then
              continue
            fi
            
            safe_name=$(echo "$line" | sed 's/[^a-zA-Z0-9]/_/g')
            track_file="track/${safe_name}.done"
            
            if [ ! -f "$track_file" ]; then
              echo "target=$line" >> $GITHUB_OUTPUT
              echo "safe_name=$safe_name" >> $GITHUB_OUTPUT
              echo "Found unscanned target: $line"
              exit 0
            fi
          done < wildcards.txt
          
          echo "All targets have been scanned"
          echo "target=" >> $GITHUB_OUTPUT

      - name: Run CrawlXSS
        if: steps.get_target.outputs.target != ''
        run: |
          echo "Scanning target: ${{ steps.get_target.outputs.target }}"
          ./crawlxss -t "${{ steps.get_target.outputs.target }}" -e -w -o "results/${{ steps.get_target.outputs.safe_name }}.json" || true

      - name: Mark target as scanned
        if: steps.get_target.outputs.target != ''
        run: |
          echo "${{ steps.get_target.outputs.target }}" > "track/${{ steps.get_target.outputs.safe_name }}.done"
          echo "Scanned at: $(date +'%Y-%m-%d %H:%M:%S')" >> "track/${{ steps.get_target.outputs.safe_name }}.done"

      - name: Commit and push results
        if: steps.get_target.outputs.target != ''
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add results/ track/
          git diff --staged --quiet || git commit -m "Scan completed: ${{ steps.get_target.outputs.target }} - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
